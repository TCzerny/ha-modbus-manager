# Configuration for Sungrow SGRT series inverters

registers:
  read:
    # Device Information
    - { name: "device_type", address: 0, type: "uint16", translation_key: "sensor.device.info.type", entity_category: "diagnostic" }
    - { name: "serial_number", address: 2, type: "string", count: 8, translation_key: "sensor.device.info.serial_number", entity_category: "diagnostic" }
    - { name: "firmware_version", address: 10, type: "uint16", scale: 0.01, translation_key: "sensor.device.info.firmware_version", entity_category: "diagnostic" }
    
    # Grid Measurements
    - { name: "grid_voltage", address: 100, type: "uint16", unit_of_measurement: "V", device_class: "voltage", state_class: "measurement", scale: 0.1, translation_key: "sensor.grid.electric.voltage" }
    - { name: "grid_current", address: 101, type: "uint16", unit_of_measurement: "A", device_class: "current", state_class: "measurement", scale: 0.1, translation_key: "sensor.grid.electric.current" }
    - { name: "grid_frequency", address: 102, type: "uint16", unit_of_measurement: "Hz", device_class: "frequency", state_class: "measurement", scale: 0.01, translation_key: "sensor.grid.electric.frequency" }
    - { name: "grid_power_factor", address: 103, type: "int16", scale: 0.001, state_class: "measurement", translation_key: "sensor.grid.electric.power_factor" }
    
    # Power Data
    - { name: "active_power", address: 200, type: "int32", unit_of_measurement: "W", device_class: "power", state_class: "measurement", scale: 1, swap: "word", translation_key: "sensor.grid.power.active" }
    - { name: "reactive_power", address: 202, type: "int32", unit_of_measurement: "var", state_class: "measurement", scale: 1, swap: "word", translation_key: "sensor.grid.power.reactive" }
    - { name: "apparent_power", address: 204, type: "uint32", unit_of_measurement: "VA", state_class: "measurement", scale: 1, swap: "word", translation_key: "sensor.grid.power.apparent" }
    
    # Energy Meters
    - { name: "energy_total", address: 300, type: "uint32", unit_of_measurement: "kWh", device_class: "energy", state_class: "total_increasing", scale: 0.1, swap: "word", translation_key: "sensor.grid.energy.total" }
    - { name: "energy_today", address: 302, type: "uint32", unit_of_measurement: "kWh", device_class: "energy", state_class: "total", scale: 0.1, swap: "word", translation_key: "sensor.grid.energy.today" }
    
    # Temperatures
    - { name: "temperature_internal", address: 400, type: "int16", unit_of_measurement: "°C", device_class: "temperature", state_class: "measurement", scale: 0.1, translation_key: "sensor.device.temperature.internal" }
    - { name: "temperature_heatsink", address: 401, type: "int16", unit_of_measurement: "°C", device_class: "temperature", state_class: "measurement", scale: 0.1, translation_key: "sensor.device.temperature.heatsink" }
    
    # Status and Errors
    - { name: "operating_state", address: 500, type: "uint16", translation_key: "sensor.device.status.state", entity_category: "diagnostic" }
    - { name: "error_code", address: 501, type: "uint16", translation_key: "sensor.device.status.error_code", entity_category: "diagnostic" }
    - { name: "warning_code", address: 502, type: "uint16", translation_key: "sensor.device.status.warning_code", entity_category: "diagnostic" }

  write:
    # Control Registers
    - { name: "active_power_control", address: 1000, type: "uint16", translation_key: "register.grid.control.active_power", entity_category: "config" }
    - { name: "reactive_power_control", address: 1001, type: "uint16", translation_key: "register.grid.control.reactive_power", entity_category: "config" }
    - { name: "power_factor_control", address: 1002, type: "int16", scale: 0.001, translation_key: "register.grid.control.power_factor", entity_category: "config" }

polling:
  fast:
    interval: 10
    registers: ["operating_state", "active_power", "grid_voltage", "grid_current"]
  normal:
    interval: 30
    registers: ["grid_frequency", "reactive_power", "apparent_power", "temperature_internal", "temperature_heatsink"]
  slow:
    interval: 300
    registers: ["energy_total", "energy_today"]

validation:
  voltage:
    min: 180
    max: 270
  current:
    min: 0
    max: 32
  frequency:
    min: 45
    max: 55
  temperature:
    min: -20
    max: 90
  power:
    min: -22000
    max: 22000
  power_factor:
    min: -1
    max: 1

automations:
  - name: "error_notification"
    trigger:
      platform: state
      entity_id: sensor.error_code
      from: "0"
      to: "!= 0"
    action:
      service: notify.notify
      data:
        title: "{{ 'notification.grid.error.title'|translate }}"
        message: "{{ 'notification.grid.error.message'|translate(error_code=states('sensor.error_code')) }}"

  - name: "high_temperature_warning"
    trigger:
      platform: numeric_state
      entity_id: sensor.temperature_internal
      above: 60
      for: "00:02:00"
    action:
      service: notify.notify
      data:
        title: "{{ 'notification.grid.temperature.warning.title'|translate }}"
        message: "{{ 'notification.grid.temperature.warning.message'|translate(temperature=states('sensor.temperature_internal')) }}"

  - name: "daily_energy_report"
    trigger:
      platform: time
      at: "23:55:00"
    action:
      service: notify.notify
      data:
        title: "{{ 'notification.grid.energy.daily.title'|translate }}"
        message: "{{ 'notification.grid.energy.daily.message'|translate(energy=states('sensor.energy_today')) }}"

helpers:
  templates:
    - name: "power_quality"
      value: >
        {% set pf = states('sensor.grid_power_factor')|float %}
        {% set thd = states('sensor.grid_thd')|float %}
        {{ (100 - (1 - abs(pf)) * 50 - thd * 2)|round(1) }}
      translation_key: "sensor.grid.metrics.power_quality"

    - name: "energy_efficiency"
      value: >
        {% set active = states('sensor.active_power')|float %}
        {% set apparent = states('sensor.apparent_power')|float %}
        {{ (active / apparent * 100)|round(1) if apparent > 0 else 0 }}
      translation_key: "sensor.grid.metrics.efficiency" 