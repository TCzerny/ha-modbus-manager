# Sungrow iHomeManager Template for Modbus Manager
# Extracted from Sungrow SHx/SG iHomeManager register mappings documentation

name: "Sungrow iHomeManager"
description: "Template for Sungrow iHomeManager EMS device (Modbus TCP). Includes iHomeManager meter, EMS, and charger registers."
manufacturer: "Sungrow"
model: "iHomeManager"
version: 1.0.2
default_prefix: "IHM"
default_slave_id: 247
type: "energy_manager"
firmware_version: "iHomeManager"

###
###  Note: iHM only supports system energy dispatch-related data forwarding and does not support data forwarding for connected devices (including inverters, WiNet-S/S2, etc.)
# V1.0.0: Initial Version
# V1.0.1: Added channel 2 data of the meter(8565~8574), Application Software Version(8318~8332), active power limit(8051~8052)
# V1.0.2: Added Feed-in limitation (8028), Changed the data type of Feed-in limitation ratio(8031) from S32 to S16.

dynamic_config:
  battery_enabled:
    description: "Enable battery-related registers"
    options: [true, false]
    default: false
  channel_2_enabled:
    description: "Enable PROD.CT channel 2 registers"
    options: [true, false]
    default: false
  charger_enabled:
    description: "Enable charger-related registers"
    options: [true, false]
    default: false

sensors:
  # Device Information
  - name: Device Type Code
    unique_id: device_type_code
    address: 7999 # reg 8000
    input_type: input
    data_type: uint16
    scan_interval: 3600
    group: "PV_device_info"
    entity_category: "diagnostic"

  # Protocol No. (8001-8002): UTF8 string, example "AW0"
  - name: Protocol Number
    unique_id: protocol_number
    address: 8000 # reg 8001-8002
    input_type: input
    data_type: string
    count: 2
    scan_interval: 3600
    group: "PV_device_info"
    entity_category: "diagnostic"

  # Protocol version (8003-8004): U32, e.g. 0x02000100 = V1.0.2
  - name: Protocol Version Raw
    unique_id: protocol_version_raw
    address: 8002 # reg 8003-8004
    input_type: input
    data_type: uint32
    swap: word
    scan_interval: 3600
    group: "PV_device_info"
    entity_category: "diagnostic"

  # Communication devices connected only via RS485/WIFI/ETH, excluding devices connected through DO;
  - name: Total Devices Connected
    unique_id: total_devices_connected
    address: 8004 # reg 8005
    input_type: input
    data_type: uint16
    state_class: measurement
    scan_interval: 300
    group: "PV_device_info"
    entity_category: "diagnostic"

  - name: Devices in Fault
    unique_id: devices_in_fault
    address: 8005 # reg 8006
    input_type: input
    data_type: uint16
    state_class: measurement
    scan_interval: 60
    group: "PV_device_info"
    entity_category: "diagnostic"

  # System Capacity
  - name: Total Nominal Active Power
    unique_id: total_nominal_active_power
    address: 8144 # reg 8145
    input_type: input
    data_type: uint32
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 300
    group: "PV_system_capacity"
    entity_category: "diagnostic"

  - name: Total Battery Rated Capacity
    unique_id: total_battery_rated_capacity
    address: 8146 # reg 8147
    input_type: input
    data_type: uint32
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kWh
    device_class: "energy"
    scan_interval: 300
    group: "PV_system_capacity"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  # Battery Limits
  - name: Battery Charge/Discharge Limit
    unique_id: battery_charge_discharge_limit
    address: 8148 # reg 8149
    input_type: input
    data_type: uint32
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 60
    group: "PV_battery_limits"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  - name: Battery Max Charge Power
    unique_id: battery_max_charge_power
    address: 8150 # reg 8151
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 60
    group: "PV_battery_limits"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  - name: Battery Min Charge Power
    unique_id: battery_min_charge_power
    address: 8151 # reg 8152
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 60
    group: "PV_battery_limits"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  - name: Battery Max Discharge Power
    unique_id: battery_max_discharge_power
    address: 8152 # reg 8153
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 60
    group: "PV_battery_limits"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  - name: Battery Min Discharge Power
    unique_id: battery_min_discharge_power
    address: 8153 # reg 8154
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    scan_interval: 60
    group: "PV_battery_limits"
    condition: "battery_enabled == true"
    entity_category: "diagnostic"

  # Total Active Power of Inverter
  # Total active power accumulated from connected inverters
  - name: Total Active Power
    unique_id: total_active_power
    address: 8154 # reg 8155 - 8156
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    scale: 10
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 10
    group: "PV_power"

  # Total Active Power of Grid Connection
  # Note 1：This data is obtained through the GRID.CT sampling port of iHM;
  - name: Meter Active Power Raw
    unique_id: meter_active_power_raw
    address: 8156 # reg 8157
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scale: 10
    scan_interval: 10
    entity_category: "diagnostic"

  - name: Load Power
    unique_id: load_power
    address: 8158 # reg 8159-8160
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    scale: 10
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 5
    group: "PV_power"

  - name: Battery Power
    unique_id: battery_power
    address: 8160 # reg 8161
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    scale: 10
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 10
    group: "PV_battery_power"
    condition: "battery_enabled == true"

  - name: Battery Level SOC
    unique_id: battery_level
    address: 8162 # reg 8163
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: "%"
    device_class: "battery"
    state_class: measurement
    scan_interval: 10
    group: "PV_battery_state"
    condition: "battery_enabled == true"

  # Energy Totals
  # Import energy at the grid connection point
  # Note 1：This data is obtained through the GRID.CT sampling port of iHM;

  - name: Grid Import Energy
    unique_id: grid_import_energy
    address: 8175 # reg 8176
    input_type: input
    data_type: uint32
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kWh
    device_class: "energy"
    state_class: total_increasing
    scan_interval: 600
    group: "PV_energy"

  # Export energy at the grid connection point
  # Note 1：This data is obtained through the GRID.CT sampling port of iHM;
  - name: Grid Export Energy
    unique_id: grid_export_energy
    address: 8177 # reg 8178
    input_type: input
    data_type: uint32
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kWh
    device_class: "energy"
    state_class: total_increasing
    scan_interval: 600
    group: "PV_energy"

  # Application Software Version
  - name: Application Software Version
    unique_id: application_software_version
    address: 8317 # reg 8318-8332
    input_type: input
    data_type: string
    count: 15
    scan_interval: 3600
    group: "PV_device_info"
    entity_category: "diagnostic"

  # Charger Status
  - name: Charger Status Raw
    unique_id: charger_status_raw
    address: 8551 # reg 8552
    input_type: input
    data_type: uint16
    state_class: measurement
    scan_interval: 10
    group: "PV_charger"
    entity_category: "diagnostic"
    condition: "charger_enabled == true"
    options:
      1: "Idle (unplugged)"
      2: "Standby (plugged)"
      3: "Charging"
      6: "Charging completed"

  - name: Output Type Raw
    unique_id: output_type_raw
    address: 8553 # reg 8554
    input_type: input
    data_type: uint16
    scale: 0.1
    unit_of_measurement: "V"
    scan_interval: 3600
    group: "PV_meter_ihm"
    entity_category: "diagnostic"
    options:
      0: "Single"
      1: "3P4L"
      2: "3P3L"

  # Output type (address 8554) is
  # 0: upload A-phase voltage;
  # is 1: upload phase voltage;
  # is 2: upload line voltage
  - name: Phase A Voltage
    unique_id: phase_a_voltage
    address: 8554 # reg 8555
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: V
    device_class: "voltage"
    state_class: measurement
    scan_interval: 60
    group: "PV_meter_ihm"

  - name: Phase B Voltage
    unique_id: phase_b_voltage
    address: 8555 # reg 8556
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: V
    device_class: "voltage"
    state_class: measurement
    scan_interval: 60
    group: "PV_meter_ihm"

  - name: Phase C Voltage
    unique_id: phase_c_voltage
    address: 8556 # reg 8557
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: V
    device_class: "voltage"
    state_class: measurement
    scan_interval: 60
    group: "PV_meter_ihm"

  - name: Grid Frequency
    unique_id: grid_frequency
    address: 8557 # reg 8558
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: Hz
    device_class: "frequency"
    state_class: measurement
    scan_interval: 60
    group: "PV_meter_ihm"

  # Note: This data is obtained through the GRID-CT sampling port of iHM
  - name: Meter Phase A Active Power Raw
    unique_id: meter_phase_a_active_power_raw
    address: 8558 # reg 8559
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scale: 1
    scan_interval: 10
    entity_category: "diagnostic"

  - name: Meter Phase B Active Power Raw
    unique_id: meter_phase_b_active_power_raw
    address: 8560 # reg 8561
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scale: 1
    scan_interval: 10
    entity_category: "diagnostic"

  - name: Meter Phase C Active Power Raw
    unique_id: meter_phase_c_active_power_raw
    address: 8562 # reg 8563
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scale: 1
    scan_interval: 10
    entity_category: "diagnostic"

  # Grid Meter Channel 2 - Voltage and Frequency
  # Note 2：This data is obtained through the PROD.CT sampling port of iHM;
  - name: Grid Frequency Ch2
    unique_id: grid_frequency_ch2
    address: 8567 # reg 8568
    input_type: input
    data_type: uint16
    precision: 1
    scale: 0.1
    unit_of_measurement: Hz
    device_class: "frequency"
    state_class: measurement
    scan_interval: 60
    group: "PV_meter_ihm_ch2"
    condition: "channel_2_enabled == true"

  # Grid Meter Channel 2 - Phase Power
  # Note 2：This data is obtained through the PROD.CT sampling port of iHM;
  - name: Phase A Active Power Ch2
    unique_id: phase_a_active_power_ch2
    address: 8568 # reg 8569
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 10
    group: "PV_meter_ihm_ch2"
    condition: "channel_2_enabled == true"

  - name: Phase B Active Power Ch2
    unique_id: phase_b_active_power_ch2
    address: 8570 # reg 8571
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 10
    group: "PV_meter_ihm_ch2"
    condition: "channel_2_enabled == true"

  - name: Phase C Active Power Ch2
    unique_id: phase_c_active_power_ch2
    address: 8572 # reg 8573
    input_type: input
    data_type: int32
    swap: word
    precision: 0
    unit_of_measurement: W
    device_class: "power"
    state_class: measurement
    scan_interval: 10
    group: "PV_meter_ihm_ch2"
    condition: "channel_2_enabled == true"

controls:
  # EMS Settings
  - type: "select"
    name: "EMS Mode Selection"
    unique_id: "ems_mode_selection"
    address: 8023 # reg 8024
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      1: "Self-consumption"
      4: "VPP"
      5: "Compulsory mode"
    group: "PV_control_ihm"

  - type: "select"
    name: "Charging/Discharging Command"
    unique_id: "charging_discharging_command"
    address: 8024 # reg 8025
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      0xAA: "Charge"
      0xBB: "Discharge"
      0xCC: "Stop"
    group: "PV_control_ihm"
    condition: "battery_enabled == true"

  - type: "number"
    name: "Charging/Discharging Power"
    unique_id: "charging_discharging_power"
    address: 8025 # reg 8026
    input_type: "holding"
    data_type: "uint32"
    swap: word
    precision: 1
    scale: 0.1
    unit_of_measurement: kW
    device_class: "power"
    min_value: 0
    max_value: 3.7  # fallback when battery_charge_discharge_limit unavailable
    max_value_from_register: "{PREFIX}_battery_charge_discharge_limit"
    step: 0.1
    mode: "box"
    scan_interval: 30
    group: "PV_control_ihm"
    condition: "battery_enabled == true"

  - type: "select"
    name: "Feed-in Power Limitation"
    unique_id: "feed_in_power_limitation"
    address: 8027 # reg 8028
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      0: "Off"
      1: "On"
    group: "PV_control_ihm"

  - type: "number"
    name: "Feed-in Power Limit Ratio"
    unique_id: "feed_in_power_limit_ratio"
    address: 8030 # reg 8031
    input_type: "holding"
    data_type: "int16"
    precision: 1
    scale: 0.1
    unit_of_measurement: "%"
    device_class: "percentage"
    min_value: 0
    max_value: 1000
    step: 1
    mode: "box"
    scan_interval: 30
    group: "PV_control_ihm"

  # external VPP heartbeat - commented out for now
  # - name: "External VPP Heartbeat"
  #   unique_id: "external_vpp_heartbeat"
  #   address: 8032 # reg 8033
  #   input_type: "holding"
  #   data_type: "uint16"
  #   unit_of_measurement: s
  #   min_value: 0
  #   max_value: 1000
  #   step: 1
  #   mode: "box"
  #   scan_interval: 30
  #   group: "PV_control_ihm"

  # Controls
  - type: "select"
    name: "Power-on/off"
    unique_id: "power_on_off"
    address: 8046 # reg 8047
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      0xCF: "Power-on"
      0xCE: "Power-off"
    group: "PV_control_ihm"

  - type: "select"
    name: "Charger Charging Modes"
    unique_id: "charger_charging_modes"
    address: 8047 # reg 8048
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      0xA0: "Fast charging mode"
      0xA1: "Eco charging mode"
    group: "PV_control_ihm"
    condition: "charger_enabled == true"

  - type: "switch"
    name: "Charger Enable"
    unique_id: "charger_enable"
    address: 8048 # reg 8049
    input_type: "holding"
    data_type: "uint16"
    write_value: 0xAA
    write_value_off: 0x55
    on_value: 0xAA
    off_value: 0x55
    scan_interval: 30
    group: "PV_control_ihm"
    condition: "charger_enabled == true"

  # Setting is allowed when the charging mode is Eco charging mode.
  - type: "select"
    name: "Charger Grid Power Draw"
    unique_id: "charger_grid_power_draw"
    address: 8049 # reg 8050
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 30
    options:
      0xAA: "Enable"
      0x55: "Disable"
    group: "PV_control_ihm"
    condition: "charger_enabled == true"

  - type: "switch"
    name: "Active Power Limitation"
    unique_id: "active_power_limitation"
    address: 8050 # reg 8051
    input_type: "holding"
    data_type: "uint16"
    write_value: 0xAA
    write_value_off: 0x55
    on_value: 0xAA
    off_value: 0x55
    scan_interval: 30
    group: "PV_control_ihm"

  - type: "number"
    name: "Active Power Limit Ratio"
    unique_id: "active_power_limit_ratio"
    address: 8051 # reg 8052
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    scale: 0.1
    unit_of_measurement: "%"
    min_value: 0
    max_value: 100
    step: 1
    mode: "box"
    scan_interval: 30
    group: "PV_control_ihm"

calculated:
  # Protocol Version (formatted) - U32 e.g. 0x02000100 = V1.0.2
  - name: "Protocol Version"
    unique_id: "protocol_version"
    type: "sensor"
    availability: "{{ not is_state('sensor.{PREFIX}_protocol_version_raw', 'unavailable') }}"
    state: >-
      {% set raw_value = states('sensor.{PREFIX}_protocol_version_raw') %}
      {% if raw_value in ['unavailable', 'unknown', 'None', ''] %}
        unknown
      {% else %}
        {% set raw = raw_value | int %}
        {% set major = (raw // 16777216) %}
        {% set minor = (raw // 65536) % 256 %}
        {% set patch = (raw // 256) % 256 %}
        V{{ major }}.{{ minor }}.{{ patch }}
      {% endif %}
    icon: "mdi:code-tags"
    group: "PV_device_info"
    entity_category: "diagnostic"

  # Net Grid Power
  - name: "Net Grid Power"
    unique_id: "net_grid_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_meter_active_power_raw', 'unavailable') }}
    state: "{{ states('sensor.{PREFIX}_meter_active_power_raw') | float(0) }}"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_grid_power"

  # Grid meter convention: positive = import (draw from grid), negative = export (feed to grid)
  - name: "Import Power"
    unique_id: "import_power"
    type: "sensor"
    availability: "{{ not is_state('sensor.{PREFIX}_meter_active_power_raw', 'unavailable') }}"
    state: >-
      {% set grid = states('sensor.{PREFIX}_meter_active_power_raw') %}
      {% if grid in ['unknown', 'unavailable', 'none'] or grid is none %}
        0
      {% elif (grid | int) > 0 %}
        {{ grid | int }}
      {% else %}
        0
      {% endif %}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_grid_power"

  - name: "Export Power"
    unique_id: "export_power"
    type: "sensor"
    availability: "{{ states('sensor.{PREFIX}_meter_active_power_raw') | is_number }}"
    state: >-
      {% set grid = states('sensor.{PREFIX}_meter_active_power_raw') %}
      {% if grid in ['unknown', 'unavailable', 'none'] or grid is none %}
        0
      {% elif (grid | int) < 0 %}
        {{ (grid | int) * -1 }}
      {% else %}
        0
      {% endif %}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_grid_power"

  # Phase Power Calculations (Channel 1)
  - name: "Total Phase Power"
    unique_id: "total_phase_power"
    type: "sensor"
    availability: >-
      {{
      not is_state('sensor.{PREFIX}_meter_phase_a_active_power_raw', 'unavailable')
      and not is_state('sensor.{PREFIX}_meter_phase_b_active_power_raw', 'unavailable')
      and not is_state('sensor.{PREFIX}_meter_phase_c_active_power_raw', 'unavailable')
      }}
    state: >-
      {{
        (states('sensor.{PREFIX}_meter_phase_a_active_power_raw') | float(0))
        + (states('sensor.{PREFIX}_meter_phase_b_active_power_raw') | float(0))
        + (states('sensor.{PREFIX}_meter_phase_c_active_power_raw') | float(0))
      }}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_phase_power"

  - name: "Phase A Power"
    unique_id: "phase_a_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_meter_phase_a_active_power_raw', 'unavailable') }}
    state: "{{ states('sensor.{PREFIX}_meter_phase_a_active_power_raw') | float(0) }}"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_phase_power"

  - name: "Phase B Power"
    unique_id: "phase_b_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_meter_phase_b_active_power_raw', 'unavailable') }}
    state: "{{ states('sensor.{PREFIX}_meter_phase_b_active_power_raw') | float(0) }}"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_phase_power"

  - name: "Phase C Power"
    unique_id: "phase_c_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_meter_phase_c_active_power_raw', 'unavailable') }}
    state: "{{ states('sensor.{PREFIX}_meter_phase_c_active_power_raw') | float(0) }}"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_phase_power"

  # Phase Power Calculations (Channel 2)
  - name: "Total Phase Power Ch2"
    unique_id: "total_phase_power_ch2"
    type: "sensor"
    condition: "channel_2_enabled == true"
    availability: >-
      {{
      not is_state('sensor.{PREFIX}_phase_a_active_power_ch2', 'unavailable')
      and not is_state('sensor.{PREFIX}_phase_b_active_power_ch2', 'unavailable')
      and not is_state('sensor.{PREFIX}_phase_c_active_power_ch2', 'unavailable')
      }}
    state: >-
      {{
        (states('sensor.{PREFIX}_phase_a_active_power_ch2') | float(0))
        + (states('sensor.{PREFIX}_phase_b_active_power_ch2') | float(0))
        + (states('sensor.{PREFIX}_phase_c_active_power_ch2') | float(0))
      }}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    precision: 0
    group: "PV_phase_power"
