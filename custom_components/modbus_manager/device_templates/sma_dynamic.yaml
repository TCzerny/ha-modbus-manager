# SMA Dynamic Template for Modbus Manager
# Source: doopa75/SMA-Inverter-ModbusTCPIP (https://github.com/doopa75/SMA-Inverter-ModbusTCPIP)
# Protocol: SMA Modbus TCP/UDP (not RTU)
# Tested on: Domoticz version 4.10717
# Documentation: https://www.sma-sunny.com/en/how-to-test-the-connection-to-your-sma-inverter/
#
# IMPORTANT NOTES:
# - Uses Modbus TCP/UDP (not RTU)
# - All values are 32-bit unsigned integers (2 registers combined)
# - Big Endian, Big Word Order
# - Invalid values: 0x7FFFFFFF (2147483647) - should be treated as 0
# - Modbus server TCP and UDP must be enabled on the inverter
# - This is a BETA template - use at your own risk

name: "SMA Sunny Tripower/Boy Series Inverter"
description: "Dynamic template for SMA Sunny Tripower and Sunny Boy series inverters. Supports PV, grid monitoring."
manufacturer: "SMA"
model: "Sunny Tripower/Boy Series Dynamic"
version: 1.0.0
default_prefix: "SMA"
default_slave_id: 1
type: "PV_Inverter"
firmware_version: "1.0.0"

# Dynamic configuration support
dynamic_config:

  valid_models:
    # Sunny Tripower Series (Three Phase, 5-20kW)
    "STP-5000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 5000}
    "STP-6000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 6000}
    "STP-7000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 7000}
    "STP-8000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 8000}
    "STP-10000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 10000}
    "STP-12000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 12000}
    "STP-15000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 15000}
    "STP-20000TL": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 20000}

    # Sunny Boy Series (Single Phase, 2.5-5kW) - Preliminary support
    "SB-2500": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 2500}
    "SB-3000": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 3000}
    "SB-4000": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 4000}
    "SB-5000": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 5000}

  # phases, mppt_count, string_count are defined by valid_models (selected model) - not duplicated here

  firmware_version:
    description: "Firmware version string"
    options: ["1.0.0", "Latest"]
    default: "1.0.0"

# Sensors for read access (Input Registers)
# Note: Register addresses from Domoticz plugin
# All values are 32-bit unsigned integers (2 registers combined)
sensors:
  # Production Data (register 30529)
  - name: "Solar Production Total"
    unique_id: "solar_production_total"
    address: 30529
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "Wh"
    device_class: "energy"
    state_class: "total_increasing"
    byte_order: "big"
    swap: "word"

  # DC Data (registers 30769-30773)
  - name: "DC Current"
    unique_id: "dc_current"
    address: 30769
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 0.001
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 3
    byte_order: "big"
    swap: "word"

  - name: "DC Voltage"
    unique_id: "dc_voltage"
    address: 30771
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 0.001
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 3
    byte_order: "big"
    swap: "word"

  - name: "DC Power"
    unique_id: "dc_power"
    address: 30773
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    byte_order: "big"
    swap: "word"

  # AC Data (registers 30775-30781)
  - name: "AC Power Total"
    unique_id: "ac_power_total"
    address: 30775
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    byte_order: "big"
    swap: "word"

  - name: "AC Power L1"
    unique_id: "ac_power_l1"
    address: 30777
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    byte_order: "big"
    swap: "word"
    condition: "phases >= 1"

  - name: "AC Power L2"
    unique_id: "ac_power_l2"
    address: 30779
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    byte_order: "big"
    swap: "word"
    condition: "phases >= 2"

  - name: "AC Power L3"
    unique_id: "ac_power_l3"
    address: 30781
    input_type: "input"
    data_type: "uint32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    byte_order: "big"
    swap: "word"
    condition: "phases >= 3"

# Calculated sensors
calculated:
  - name: "PV Power Total"
    unique_id: "pv_power_total"
    template: "{PREFIX}_dc_power"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"

  - name: "AC Power Phase Total"
    unique_id: "ac_power_phase_total"
    template: "{PREFIX}_ac_power_l1 + {PREFIX}_ac_power_l2 + {PREFIX}_ac_power_l3"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 3"

# Binary sensors
binary_sensors:
  - name: "PV Generating"
    unique_id: "pv_generating"
    template: "{PREFIX}_pv_power_total"
    device_class: "power"
    condition: "{PREFIX}_pv_power_total > 0"

  - name: "AC Power Active"
    unique_id: "ac_power_active"
    template: "{PREFIX}_ac_power_total"
    device_class: "power"
    condition: "{PREFIX}_ac_power_total > 0"
