# Huawei Inverter Template basierend auf SunSpec Standard
# Verwendet die korrekte SunSpec-Modellstruktur mit Offsets

name: "Huawei Inverter (SunSpec Standard)"
extends: "SunSpec Standard"
version: 1
description: "Huawei Wechselrichter (Luna, FusionSolar) mit standardkonformem SunSpec-Mapping"
manufacturer: "Huawei"
model: "Luna/FusionSolar Series"

# SunSpec-Modellbasis-Adressen für Huawei
# Huawei implementiert SunSpec ab Register 40001 (Modbus-Adresse 0)
model_addresses:
  common_model: 40001   # Common Model (1) beginnt bei 40001
  inverter_model: 40069  # Inverter Model (103) beginnt bei 40069
  storage_model: 40187   # Storage Model (124) beginnt bei 40187
  meter_model: 40277     # Meter Model (203) beginnt bei 40277

# Herstellerspezifische Register, die nicht Teil des SunSpec-Standards sind
custom_registers:
  - name: "System Time"
    unique_id: "system_time"
    address: 40093
    input_type: "holding"
    data_type: "uint32"
    count: 2
    precision: 0
    unit_of_measurement: "s"
    state_class: "total_increasing"
    scan_interval: 300
    description: "System Uptime"
    group: "system"

  - name: "Grid Frequency"
    unique_id: "grid_frequency"
    address: 40095
    input_type: "holding"
    data_type: "uint16"
    precision: 2
    unit_of_measurement: "Hz"
    device_class: "frequency"
    state_class: "measurement"
    scale: 0.01
    scan_interval: 60
    description: "Grid Frequency"
    group: "grid"

  - name: "Daily Energy"
    unique_id: "daily_energy"
    address: 40097
    input_type: "holding"
    data_type: "uint32"
    count: 2
    precision: 0
    unit_of_measurement: "Wh"
    device_class: "energy"
    state_class: "total_increasing"
    scan_interval: 60
    description: "Daily Energy Production"
    group: "energy_daily"

  - name: "Monthly Energy"
    unique_id: "monthly_energy"
    address: 40099
    input_type: "holding"
    data_type: "uint32"
    count: 2
    precision: 0
    unit_of_measurement: "Wh"
    device_class: "energy"
    state_class: "total_increasing"
    scan_interval: 300
    description: "Monthly Energy Production"
    group: "energy_monthly"

  - name: "Yearly Energy"
    unique_id: "yearly_energy"
    address: 40101
    input_type: "holding"
    data_type: "uint32"
    count: 2
    precision: 0
    unit_of_measurement: "Wh"
    device_class: "energy"
    state_class: "total_increasing"
    scan_interval: 300
    description: "Yearly Energy Production"
    group: "energy_yearly"

  - name: "Total Energy"
    unique_id: "total_energy"
    address: 40103
    input_type: "holding"
    data_type: "uint32"
    count: 2
    precision: 0
    unit_of_measurement: "Wh"
    device_class: "energy"
    state_class: "total_increasing"
    scan_interval: 300
    description: "Total Lifetime Energy Production"
    group: "energy_total"

  # MPPT-spezifische Register
  - name: "MPPT 1 Voltage"
    unique_id: "mppt1_voltage"
    address: 40263
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    scale: 0.1
    scan_interval: 60
    description: "MPPT 1 DC Voltage"
    group: "mppt1"

  - name: "MPPT 1 Current"
    unique_id: "mppt1_current"
    address: 40264
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    scale: 0.1
    scan_interval: 60
    description: "MPPT 1 DC Current"
    group: "mppt1"

  - name: "MPPT 1 Power"
    unique_id: "mppt1_power"
    address: 40265
    input_type: "holding"
    data_type: "uint16"
    precision: 0
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    scale: 1
    scan_interval: 60
    description: "MPPT 1 DC Power"
    group: "mppt1"

  - name: "MPPT 2 Voltage"
    unique_id: "mppt2_voltage"
    address: 40266
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    scale: 0.1
    scan_interval: 60
    description: "MPPT 2 DC Voltage"
    group: "mppt2"

  - name: "MPPT 2 Current"
    unique_id: "mppt2_current"
    address: 40267
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    scale: 0.1
    scan_interval: 60
    description: "MPPT 2 DC Current"
    group: "mppt2"

  - name: "MPPT 2 Power"
    unique_id: "mppt2_power"
    address: 40268
    input_type: "holding"
    data_type: "uint16"
    precision: 0
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    scale: 1
    scan_interval: 60
    description: "MPPT 2 DC Power"
    group: "mppt2"

# Herstellerspezifische Controls
custom_controls:
  - type: "select"
    name: "Operation Mode"
    address: 40151
    input_type: "holding"
    data_type: "uint16"
    options:
      1: "On"
      2: "Off"
      3: "Standby"
      4: "Grid Support"
    group: "control"

  - type: "number"
    name: "Power Limit"
    address: 40153
    input_type: "holding"
    data_type: "uint16"
    precision: 1
    unit_of_measurement: "%"
    device_class: null
    state_class: "measurement"
    scale: 0.1
    min_value: 0
    max_value: 100
    step: 1
    group: "control"

  - type: "select"
    name: "Battery Mode"
    address: 40800
    input_type: "holding"
    data_type: "uint16"
    options:
      1: "Off"
      2: "Automatic"
      3: "Charge Only"
      4: "Discharge Only"
      5: "Grid Support"
    group: "battery_control"

# Berechnete Entitäten
calculated:
  - name: "Self Consumption"
    unique_id: "self_consumption"
    type: "sensor"
    availability: >-
      {{ 
      not is_state('sensor.{PREFIX}_i_dc_power', 'unavailable') and
      not is_state('sensor.{PREFIX}_m_ac_power', 'unavailable') 
      }}
    template: >-
      {% set pv_power = states('sensor.{PREFIX}_i_dc_power') | float(0) %}
      {% set grid_power = states('sensor.{PREFIX}_m_ac_power') | float(0) %}
      {% if pv_power > 0 %}
        {% set self_consumption = pv_power - (grid_power * -1) if grid_power < 0 else pv_power %}
        {{ [0, self_consumption] | max }}
      {% else %}
        0
      {% endif %}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    group: "power_flow"

  - name: "Inverter Efficiency"
    unique_id: "inverter_efficiency"
    type: "sensor"
    availability: >-
      {{ 
      not is_state('sensor.{PREFIX}_i_dc_power', 'unavailable') and
      not is_state('sensor.{PREFIX}_i_ac_power', 'unavailable') and
      states('sensor.{PREFIX}_i_dc_power') | float(0) > 100
      }}
    template: >-
      {% set dc = states('sensor.{PREFIX}_i_dc_power') | float(0) %}
      {% set ac = states('sensor.{PREFIX}_i_ac_power') | float(0) %}
      {% if dc > 0 %}{{ ((ac / dc) * 100) | round(1) }}{% else %}0{% endif %}
    unit_of_measurement: "%"
    device_class: "power_factor"
    state_class: "measurement"
    group: "efficiency"

  - name: "Home Consumption"
    unique_id: "home_consumption"
    type: "sensor"
    availability: >-
      {{ 
      not is_state('sensor.{PREFIX}_i_ac_power', 'unavailable') and
      not is_state('sensor.{PREFIX}_m_ac_power', 'unavailable')
      }}
    template: >-
      {% set inverter_power = states('sensor.{PREFIX}_i_dc_power') | float(0) %}
      {% set grid_power = states('sensor.{PREFIX}_m_ac_power') | float(0) %}
      {{ inverter_power + grid_power }}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    group: "power_flow"
