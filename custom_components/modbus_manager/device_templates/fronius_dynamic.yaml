# Fronius GEN24 Dynamic Template for Modbus Manager
# Source: otti/FroniusModbusRtu (https://github.com/otti/FroniusModbusRtu)
# Official Documentation: https://manuals.fronius.com/html/4204102649/en-US.html
# Protocol: Fronius Modbus RTU/TCP - Uses Holding Registers
# Tested with: Fronius Symo GEN24 10.0 Plus (SW: 1.19.7-1)
#
# IMPORTANT NOTES:
# - Fronius uses Holding Registers (not Input Registers) for both read and write
# - All values are 32-bit signed integers (2 registers combined)
# - Low word stored at lower address
# - Energy values stored in 4 registers (kWh + Wh)
# - SunSpec Models: 103 (Single Phase Inverter), 160 (Multiple MPPT Extension), 124 (Battery)

name: "Fronius GEN24 Series Inverter"
description: "Dynamic template for Fronius GEN24 series inverters with SunSpec protocol support. Supports PV, grid, and battery monitoring."
manufacturer: "Fronius"
model: "GEN24 Series Dynamic"
version: 1.0.0
default_prefix: "Fronius"
default_slave_id: 1
type: "PV_Hybrid_Inverter"
firmware_version: "1.19.7-1"

# SunSpec protocol support
# SunSpec model addresses are now configured via dynamic_config below
# Auto-detection happens at runtime in the coordinator
# These fields allow manual override if auto-detection fails or device has non-standard addresses

# Dynamic configuration support
dynamic_config:

  valid_models:
    # GEN24 Series (Single Phase and Three Phase)
    # Models: 6.0, 8.0, 10.0, 12.0 kW with Plus variants (battery support)
    "GEN24-6.0": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 6000}
    "GEN24-8.0": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 8000}
    "GEN24-10.0": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 10000}
    "GEN24-12.0": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: false, max_ac_output_power: 12000}
    "GEN24-6.0-Plus": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: true, max_ac_output_power: 6000}
    "GEN24-8.0-Plus": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: true, max_ac_output_power: 8000}
    "GEN24-10.0-Plus": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: true, max_ac_output_power: 10000}
    "GEN24-12.0-Plus": {phases: 1, mppt_count: 1, string_count: 1, battery_enabled: true, max_ac_output_power: 12000}
    # Three Phase variants (if available)
    "GEN24-10.0-3P": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: false, max_ac_output_power: 10000}
    "GEN24-10.0-3P-Plus": {phases: 3, mppt_count: 2, string_count: 2, battery_enabled: true, max_ac_output_power: 10000}

  # phases, mppt_count, string_count are defined by valid_models (selected model) - not duplicated here

  battery_config:
    description: "Battery configuration"
    options: ["none", "fronius_battery"]
    default: "none"

  firmware_version:
    description: "Firmware version string"
    options: ["1.19.7-1", "Latest"]
    default: "1.19.7-1"

  # SunSpec model address fields (optional - auto-detection happens at runtime)
  # Only change if auto-detection fails or device uses non-standard addresses
  sunspec_model_103_address:
    description: "SunSpec Model 103 Start Address (Inverter Base Model - PV data for single MPPT)"
    default: 40070
    min: 1
    max: 65535

  sunspec_model_160_address:
    description: "SunSpec Model 160 Start Address (Multiple MPPT Extension - PV data for multiple MPPTs)"
    default: 40253
    min: 1
    max: 65535

  sunspec_model_124_address:
    description: "SunSpec Model 124 Start Address (Battery Storage Control - Battery data)"
    default: 40000
    min: 1
    max: 65535

# Sensors for read access (Holding Registers)
sensors:
  # Summary measurements (register 258-273)
  - name: "Grid Voltage L1"
    unique_id: "grid_voltage_l1"
    address: 258
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1

  - name: "Grid Voltage L2"
    unique_id: "grid_voltage_l2"
    address: 260
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1
    condition: "phases >= 2"

  - name: "Grid Voltage L3"
    unique_id: "grid_voltage_l3"
    address: 262
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1
    condition: "phases >= 3"

  - name: "Grid Current L1"
    unique_id: "grid_current_l1"
    address: 264
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2

  - name: "Grid Current L2"
    unique_id: "grid_current_l2"
    address: 266
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2
    condition: "phases >= 2"

  - name: "Grid Current L3"
    unique_id: "grid_current_l3"
    address: 268
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2
    condition: "phases >= 3"

  - name: "Grid Power L1"
    unique_id: "grid_power_l1"
    address: 270
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"

  - name: "Grid Power L2"
    unique_id: "grid_power_l2"
    address: 272
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 2"

  - name: "Grid Power L3"
    unique_id: "grid_power_l3"
    address: 274
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 3"

  - name: "Grid Frequency"
    unique_id: "grid_frequency"
    address: 276
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "Hz"
    device_class: "frequency"
    state_class: "measurement"
    precision: 2

  # Per-phase measurements (register 286-327)
  - name: "Phase A Voltage"
    unique_id: "phase_a_voltage"
    address: 286
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1

  - name: "Phase B Voltage"
    unique_id: "phase_b_voltage"
    address: 294
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1
    condition: "phases >= 2"

  - name: "Phase C Voltage"
    unique_id: "phase_c_voltage"
    address: 302
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1
    condition: "phases >= 3"

  - name: "Phase A Current"
    unique_id: "phase_a_current"
    address: 288
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2

  - name: "Phase B Current"
    unique_id: "phase_b_current"
    address: 296
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2
    condition: "phases >= 2"

  - name: "Phase C Current"
    unique_id: "phase_c_current"
    address: 304
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.01
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 2
    condition: "phases >= 3"

  - name: "Phase A Power"
    unique_id: "phase_a_power"
    address: 290
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"

  - name: "Phase B Power"
    unique_id: "phase_b_power"
    address: 298
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 2"

  - name: "Phase C Power"
    unique_id: "phase_c_power"
    address: 306
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 3"

  - name: "Phase A Power Factor"
    unique_id: "phase_a_power_factor"
    address: 292
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.001
    unit_of_measurement: ""
    device_class: "power_factor"
    state_class: "measurement"
    precision: 3

  - name: "Phase B Power Factor"
    unique_id: "phase_b_power_factor"
    address: 300
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.001
    unit_of_measurement: ""
    device_class: "power_factor"
    state_class: "measurement"
    precision: 3
    condition: "phases >= 2"

  - name: "Phase C Power Factor"
    unique_id: "phase_c_power_factor"
    address: 308
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 0.001
    unit_of_measurement: ""
    device_class: "power_factor"
    state_class: "measurement"
    precision: 3
    condition: "phases >= 3"

  # Energy measurements (register 1024-1039) - kWh + Wh format
  - name: "Energy Consumed Total"
    unique_id: "energy_consumed_total"
    address: 1024
    input_type: "holding"
    data_type: "int32"
    count: 4
    scale: 1
    unit_of_measurement: "kWh"
    device_class: "energy"
    state_class: "total_increasing"
    precision: 1

  - name: "Energy Produced Total"
    unique_id: "energy_produced_total"
    address: 1028
    input_type: "holding"
    data_type: "int32"
    count: 4
    scale: 1
    unit_of_measurement: "kWh"
    device_class: "energy"
    state_class: "total_increasing"
    precision: 1

  # SunSpec Model 103 - Single Phase Inverter (PV Data for single DC input)
  # Register addresses calculated dynamically based on SunSpec model start address
  - name: "PV DC Voltage"
    unique_id: "pv_dc_voltage"
    address: 40097  # Fallback address
    sunspec_model: 103
    sunspec_offset: 25  # DC Voltage offset in Model 103
    input_type: "holding"
    data_type: "uint16"
    count: 1
    scale: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    condition: "mppt_count == 1"

  - name: "PV DC Current"
    unique_id: "pv_dc_current"
    address: 40098  # Fallback address
    sunspec_model: 103
    sunspec_offset: 26  # DC Current offset in Model 103
    input_type: "holding"
    data_type: "int16"
    count: 1
    scale: 0.1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 1
    condition: "mppt_count == 1"

  - name: "PV DC Power"
    unique_id: "pv_dc_power"
    address: 40099  # Fallback address
    sunspec_model: 103
    sunspec_offset: 27  # DC Power offset in Model 103
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "mppt_count == 1"

  # SunSpec Model 160 - Multiple MPPT Inverter Extension (PV Data for multiple DC inputs)
  - name: "PV MPPT1 Voltage"
    unique_id: "pv_mppt1_voltage"
    address: 40255  # Fallback address
    sunspec_model: 160
    sunspec_offset: 0  # MPPT1 Voltage offset in Model 160
    input_type: "holding"
    data_type: "uint16"
    count: 1
    scale: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    condition: "mppt_count >= 2"

  - name: "PV MPPT1 Current"
    unique_id: "pv_mppt1_current"
    address: 40256  # Fallback address
    sunspec_model: 160
    sunspec_offset: 1  # MPPT1 Current offset in Model 160
    input_type: "holding"
    data_type: "int16"
    count: 1
    scale: 0.1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 1
    condition: "mppt_count >= 2"

  - name: "PV MPPT1 Power"
    unique_id: "pv_mppt1_power"
    address: 40257  # Fallback address
    sunspec_model: 160
    sunspec_offset: 2  # MPPT1 Power offset in Model 160
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "mppt_count >= 2"

  - name: "PV MPPT2 Voltage"
    unique_id: "pv_mppt2_voltage"
    address: 40260  # Fallback address
    sunspec_model: 160
    sunspec_offset: 5  # MPPT2 Voltage offset in Model 160
    input_type: "holding"
    data_type: "uint16"
    count: 1
    scale: 1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    condition: "mppt_count >= 2"

  - name: "PV MPPT2 Current"
    unique_id: "pv_mppt2_current"
    address: 40261  # Fallback address
    sunspec_model: 160
    sunspec_offset: 6  # MPPT2 Current offset in Model 160
    input_type: "holding"
    data_type: "int16"
    count: 1
    scale: 0.1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 1
    condition: "mppt_count >= 2"

  - name: "PV MPPT2 Power"
    unique_id: "pv_mppt2_power"
    address: 40262  # Fallback address
    sunspec_model: 160
    sunspec_offset: 7  # MPPT2 Power offset in Model 160
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "mppt_count >= 2"

  # SunSpec Model 124 - Battery Storage Control (for GEN24 Plus models)
  - name: "Battery Voltage"
    unique_id: "battery_voltage"
    address: 40002  # Fallback address
    sunspec_model: 124
    sunspec_offset: 0  # Battery Voltage offset in Model 124
    input_type: "holding"
    data_type: "uint16"
    count: 1
    scale: 0.1
    unit_of_measurement: "V"
    device_class: "voltage"
    state_class: "measurement"
    precision: 1
    condition: "battery_enabled == true"

  - name: "Battery Current"
    unique_id: "battery_current"
    address: 40003  # Fallback address
    sunspec_model: 124
    sunspec_offset: 1  # Battery Current offset in Model 124
    input_type: "holding"
    data_type: "int16"
    count: 1
    scale: 0.1
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    precision: 1
    condition: "battery_enabled == true"

  - name: "Battery Power"
    unique_id: "battery_power"
    address: 40004  # Fallback address
    sunspec_model: 124
    sunspec_offset: 2  # Battery Power offset in Model 124
    input_type: "holding"
    data_type: "int32"
    count: 2
    scale: 1
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "battery_enabled == true"

  - name: "Battery SOC"
    unique_id: "battery_soc"
    address: 40006  # Fallback address
    sunspec_model: 124
    sunspec_offset: 4  # Battery SOC offset in Model 124
    input_type: "holding"
    data_type: "uint16"
    count: 1
    scale: 0.1
    unit_of_measurement: "%"
    device_class: "battery"
    state_class: "measurement"
    precision: 1
    condition: "battery_enabled == true"

# Calculated sensors
calculated:
  - name: "PV Power Total"
    unique_id: "pv_power_total"
    template: "{PREFIX}_pv_dc_power + {PREFIX}_pv_mppt1_power + {PREFIX}_pv_mppt2_power"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"

  - name: "Grid Power Total"
    unique_id: "grid_power_total"
    template: "{PREFIX}_grid_power_l1 + {PREFIX}_grid_power_l2 + {PREFIX}_grid_power_l3"
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    condition: "phases >= 3"

# Binary sensors
binary_sensors:
  - name: "PV Generating"
    unique_id: "pv_generating"
    template: "{PREFIX}_pv_power_total"
    device_class: "power"
    condition: "{PREFIX}_pv_power_total > 0"

  - name: "Grid Importing"
    unique_id: "grid_importing"
    template: "{PREFIX}_grid_power_total"
    device_class: "power"
    condition: "{PREFIX}_grid_power_total < 0"

  - name: "Grid Exporting"
    unique_id: "grid_exporting"
    template: "{PREFIX}_grid_power_total"
    device_class: "power"
    condition: "{PREFIX}_grid_power_total > 0"
