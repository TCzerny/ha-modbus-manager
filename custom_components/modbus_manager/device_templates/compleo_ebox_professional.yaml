name: "Compleo eBox Professional"
version: 1
description: "Compleo eBox Professional EV Charger (Innogy eBox)"
manufacturer: "Compleo"
model: "eBox Professional"
type: "ev_charger"

# Device information sensors
sensors:
  # Device identification
  - name: "eBox ID"
    unique_id: "ebox_id"
    address: 0
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 0
    group: "EV_device_info"
    icon: "mdi:identifier"

  - name: "eBox Serial Number"
    unique_id: "ebox_serial_number"
    address: 25
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 0
    group: "EV_device_info"
    icon: "mdi:barcode"

  - name: "eBox Active Protocol"
    unique_id: "ebox_active_protocol"
    address: 50
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 600
    group: "EV_device_info"
    icon: "mdi:protocol"

  - name: "eBox Manufacturer"
    unique_id: "ebox_manufacturer"
    address: 100
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 0
    group: "EV_device_info"
    icon: "mdi:factory"

  - name: "eBox Firmware"
    unique_id: "ebox_firmware"
    address: 200
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 600
    group: "EV_device_info"
    icon: "mdi:chip"

  # Charging status
  - name: "eBox Status"
    unique_id: "ebox_status"
    address: 275
    input_type: "input"
    data_type: "string"
    count: 25
    scan_interval: 120
    group: "EV_charging_status"
    icon: "mdi:ev-station"

  - name: "eBox Cable Status"
    unique_id: "ebox_cable_status"
    address: 300
    input_type: "input"
    data_type: "uint16"
    scan_interval: 120
    group: "EV_charging_status"
    icon: "mdi:cable-data"

  # Current measurements
  - name: "eBox Current Phase 1"
    unique_id: "ebox_current_phase_1"
    address: 1006
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_current_measurement"
    icon: "mdi:lightning-bolt"

  - name: "eBox Current Phase 2"
    unique_id: "ebox_current_phase_2"
    address: 1008
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_current_measurement"
    icon: "mdi:lightning-bolt"

  - name: "eBox Current Phase 3"
    unique_id: "ebox_current_phase_3"
    address: 1010
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_current_measurement"
    icon: "mdi:lightning-bolt"

  # Actual max current (read-only)
  - name: "eBox Actual Max Current Phase 1"
    unique_id: "ebox_actual_max_current_phase_1"
    address: 1000
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_actual"
    icon: "mdi:gauge"

  - name: "eBox Actual Max Current Phase 2"
    unique_id: "ebox_actual_max_current_phase_2"
    address: 1002
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_actual"
    icon: "mdi:gauge"

  - name: "eBox Actual Max Current Phase 3"
    unique_id: "ebox_actual_max_current_phase_3"
    address: 1004
    input_type: "input"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_actual"
    icon: "mdi:gauge"

# Controls (holding registers - read/write)
controls:
  # Max current settings (holding registers)
  - name: "eBox Max Current Phase 1"
    unique_id: "ebox_max_current_phase_1"
    address: 1012
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  - name: "eBox Max Current Phase 2"
    unique_id: "ebox_max_current_phase_2"
    address: 1014
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  - name: "eBox Max Current Phase 3"
    unique_id: "ebox_max_current_phase_3"
    address: 1016
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  # Fallback max current settings
  - name: "eBox Fallback Max Current Phase 1"
    unique_id: "ebox_fallback_max_current_phase_1"
    address: 1018
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_fallback_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  - name: "eBox Fallback Max Current Phase 2"
    unique_id: "ebox_fallback_max_current_phase_2"
    address: 1020
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_fallback_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  - name: "eBox Fallback Max Current Phase 3"
    unique_id: "ebox_fallback_max_current_phase_3"
    address: 1022
    input_type: "holding"
    data_type: "float32"
    count: 2
    scan_interval: 10
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_fallback_current_setting"
    icon: "mdi:gauge"
    min_value: 0
    max_value: 16
    step: 1

  # Fallback timer
  - name: "eBox Remaining Time Before Fallback"
    unique_id: "ebox_remaining_time_before_fallback"
    address: 1024
    input_type: "holding"
    data_type: "uint16"
    scan_interval: 10
    unit_of_measurement: "min"
    device_class: "duration"
    state_class: "measurement"
    group: "EV_fallback_timer"
    icon: "mdi:timer"

# Calculated sensors
calculated_sensors:
  - name: "eBox Total Current"
    unique_id: "ebox_total_current"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_current_phase_1', 'unavailable') and
         not is_state('sensor.{PREFIX}_current_phase_2', 'unavailable') and
         not is_state('sensor.{PREFIX}_current_phase_3', 'unavailable') }}
    state: >-
      {{ (states('sensor.{PREFIX}_current_phase_1') | default(0) | float +
          states('sensor.{PREFIX}_current_phase_2') | default(0) | float +
          states('sensor.{PREFIX}_current_phase_3') | default(0) | float) | round(2) }}
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_current_measurement"
    icon: "mdi:lightning-bolt"

  - name: "eBox Charging Power"
    unique_id: "ebox_charging_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_current_phase_1', 'unavailable') and
         not is_state('sensor.{PREFIX}_current_phase_2', 'unavailable') and
         not is_state('sensor.{PREFIX}_current_phase_3', 'unavailable') }}
    state: >-
      {% set current1 = states('sensor.{PREFIX}_current_phase_1') | default(0) | float %}
      {% set current2 = states('sensor.{PREFIX}_current_phase_2') | default(0) | float %}
      {% set current3 = states('sensor.{PREFIX}_current_phase_3') | default(0) | float %}
      {% if current1 > 0.11 or current2 > 0.11 or current3 > 0.11 %}
        {{ ((current1 + current2 + current3) - 0.27) * 220 | round(0) }}
      {% else %}
        0
      {% endif %}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    group: "EV_charging_power"
    icon: "mdi:ev-station"

  - name: "eBox Max Total Current"
    unique_id: "ebox_max_total_current"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_max_current_phase_1', 'unavailable') and
         not is_state('sensor.{PREFIX}_max_current_phase_2', 'unavailable') and
         not is_state('sensor.{PREFIX}_max_current_phase_3', 'unavailable') }}
    state: >-
      {{ (states('sensor.{PREFIX}_max_current_phase_1') | default(0) | float +
          states('sensor.{PREFIX}_max_current_phase_2') | default(0) | float +
          states('sensor.{PREFIX}_max_current_phase_3') | default(0) | float) | round(2) }}
    unit_of_measurement: "A"
    device_class: "current"
    state_class: "measurement"
    group: "EV_max_current_setting"
    icon: "mdi:gauge"

  - name: "eBox Max Charging Power"
    unique_id: "ebox_max_charging_power"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_max_current_phase_1', 'unavailable') and
         not is_state('sensor.{PREFIX}_max_current_phase_2', 'unavailable') and
         not is_state('sensor.{PREFIX}_max_current_phase_3', 'unavailable') }}
    state: >-
      {{ (states('sensor.{PREFIX}_max_current_phase_1') | default(0) | float +
          states('sensor.{PREFIX}_max_current_phase_2') | default(0) | float +
          states('sensor.{PREFIX}_max_current_phase_3') | default(0) | float) * 220 | round(0) }}
    unit_of_measurement: "W"
    device_class: "power"
    state_class: "measurement"
    group: "EV_max_charging_power"
    icon: "mdi:ev-station"

  - name: "eBox Charging Efficiency"
    unique_id: "ebox_charging_efficiency"
    type: "sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_charging_power', 'unavailable') and
         not is_state('sensor.{PREFIX}_max_charging_power', 'unavailable') and
         states('sensor.{PREFIX}_max_charging_power') | default(0) | float > 0 }}
    state: >-
      {{ (states('sensor.{PREFIX}_charging_power') | default(0) | float /
          states('sensor.{PREFIX}_max_charging_power') | default(1) | float * 100) | round(1) }}
    unit_of_measurement: "%"
    device_class: "power_factor"
    state_class: "measurement"
    group: "EV_efficiency"
    icon: "mdi:gauge"

# Binary sensors for status
binary_sensors:
  - name: "eBox Charging Active"
    unique_id: "ebox_charging_active"
    type: "binary_sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_charging_power', 'unavailable') }}
    state: >-
      {{ states('sensor.{PREFIX}_charging_power') | default(0) | float > 0 }}
    device_class: "power"
    group: "EV_charging_status"
    icon: "mdi:ev-station"

  - name: "eBox Cable Connected"
    unique_id: "ebox_cable_connected"
    type: "binary_sensor"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_cable_status', 'unavailable') }}
    state: >-
      {{ states('sensor.{PREFIX}_cable_status') | default(0) | int == 3 }}
    device_class: "connectivity"
    group: "EV_charging_status"
    icon: "mdi:cable-data"

# Numbers for current control
numbers:
  - name: "eBox Set Max Current"
    unique_id: "ebox_set_max_current"
    type: "number"
    availability: >-
      {{ not is_state('sensor.{PREFIX}_cable_status', 'unavailable') }}
    state: >-
      {{ states('sensor.{PREFIX}_max_total_current') | default(0) | float }}
    min_value: 0
    max_value: 16
    step: 1
    unit_of_measurement: "A"
    mode: "box"
    group: "EV_current_control"
    icon: "mdi:gauge"
    # This would need to be implemented as a service call to update all three phases
